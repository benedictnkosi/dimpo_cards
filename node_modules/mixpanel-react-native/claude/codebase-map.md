# Codebase Map: mixpanel-react-native

## Executive Summary

This is a React Native library implementing Mixpanel analytics with a **dual architecture strategy**: native iOS/Android modules for performance plus pure JavaScript fallback for Expo/Web compatibility. The codebase demonstrates sophisticated cross-platform patterns with token-based multi-instance support.

## ğŸ¯ Entry Points

### Primary Library Interface
- `index.js` - Main export exposing Mixpanel, People, and MixpanelGroup classes
- `index.d.ts` - TypeScript definitions with comprehensive type coverage
- `package.json` - Library metadata, dependencies (AsyncStorage, uuid, expo-crypto)

### Configuration
- `react-native.config.js` - React Native autolinking configuration for native modules
- `MixpanelReactNative.podspec` - iOS CocoaPods specification

## ğŸ—ï¸ Core Architecture Components

### Native Implementation (Performance Path)
```
ios/
â”œâ”€â”€ MixpanelReactNative.swift          # iOS bridge using Mixpanel Swift SDK
â”œâ”€â”€ MixpanelReactNative.m              # Objective-C bridge file
â”œâ”€â”€ AutomaticProperties.swift          # Device property collection
â”œâ”€â”€ MixpanelTypeHandler.swift          # Type conversion utilities
â””â”€â”€ Constants.swift                    # iOS-specific constants

android/src/main/java/com/mixpanel/reactnative/
â”œâ”€â”€ MixpanelReactNativeModule.java     # Android bridge using Mixpanel Android SDK
â”œâ”€â”€ MixpanelReactNativePackage.java    # React Native package registration
â”œâ”€â”€ AutomaticProperties.java          # Device property collection
â””â”€â”€ ReactNativeHelper.java            # Utility functions
```

### JavaScript Implementation (Compatibility Path)
```
javascript/
â”œâ”€â”€ mixpanel-main.js                   # JS mode entry point - full API implementation
â”œâ”€â”€ mixpanel-core.js                   # Core tracking logic shared between modes
â”œâ”€â”€ mixpanel-queue.js                  # Event queue management with auto-flush
â”œâ”€â”€ mixpanel-network.js                # HTTP client with retry logic
â”œâ”€â”€ mixpanel-storage.js                # AsyncStorage abstraction layer
â”œâ”€â”€ mixpanel-persistent.js             # State persistence management
â”œâ”€â”€ mixpanel-config.js                 # Configuration management
â”œâ”€â”€ mixpanel-logger.js                 # Centralized logging system
â”œâ”€â”€ mixpanel-constants.js              # Shared constants and enums
â””â”€â”€ mixpanel-utils.js                  # Utility functions
```

## ğŸ§ª Testing Infrastructure

### Test Organization
```
__tests__/
â”œâ”€â”€ jest_setup.js                      # Test environment configuration
â”œâ”€â”€ core.test.js                       # Core functionality tests
â”œâ”€â”€ index.test.js                      # Main API tests
â”œâ”€â”€ main.test.js                       # JavaScript implementation tests
â”œâ”€â”€ network.test.js                    # HTTP client tests
â””â”€â”€ queue.test.js                      # Queue management tests

__mocks__/
â””â”€â”€ @react-native-async-storage/       # AsyncStorage mock for testing
    â””â”€â”€ async-storage.js
```

### Test Patterns
- **Comprehensive mocking**: All external dependencies (AsyncStorage, React Native modules)
- **Jest configuration**: Custom setup with React Native preset
- **Module isolation**: Each core component tested independently

## ğŸ“± Sample Applications

### Development/Testing Apps
```
Samples/
â”œâ”€â”€ SimpleMixpanel/                     # Basic integration example (TypeScript)
â”œâ”€â”€ MixpanelDemo/                      # Full-featured demo app
â”œâ”€â”€ ContextAPIMixpanel/                # React Context API integration
â””â”€â”€ MixpanelExpo/                      # Expo-compatible example
```

Each sample includes complete React Native app structure with platform-specific builds.

## ğŸ“š Documentation

### Generated Documentation
```
docs/                                   # JSDoc-generated API documentation
â”œâ”€â”€ index.html                         # Main documentation entry
â”œâ”€â”€ Mixpanel.html                      # Mixpanel class documentation
â”œâ”€â”€ People.html                        # People Analytics documentation
â””â”€â”€ MixpanelGroup.html                 # Group Analytics documentation
```

### Maintenance Scripts
- `generate_docs.sh` - JSDoc documentation generation script
- `release.py` - Release automation script

## ğŸ” Key Architectural Insights

### Multi-Instance Design
- **Token-based isolation**: Each Mixpanel project gets separate instance
- **Shared infrastructure**: Common queue, network, and storage layers
- **State persistence**: User IDs, super properties survive app restarts

### Cross-Platform Strategy
- **Automatic fallback**: Native â†’ JavaScript mode based on availability
- **Platform detection**: iOS/Android-specific behavior handling
- **Unified API**: Same interface regardless of implementation mode

### Performance Considerations
- **Batched flushing**: Events sent in configurable batches (default 50)
- **Background flushing**: Automatic data transmission on app state changes
- **Memory management**: In-memory queues with persistent backup

### Error Handling Philosophy
- **Graceful degradation**: JavaScript mode as native fallback
- **Input validation**: Comprehensive parameter checking with helpful errors
- **Logging strategy**: Centralized, configurable logging system

## ğŸ”§ Configuration Patterns

### React Native Integration
- **Autolinking**: Automatic native module discovery
- **Manual linking support**: Fallback for older RN versions
- **Metro bundler**: Standard React Native build pipeline

### Dependencies Strategy [Updated: 2025-05-30]
- **Minimal external deps**: Only essential libraries (AsyncStorage, uuid, expo-crypto)
- **Platform compatibility**: Enhanced Expo support with expo-crypto for UUID generation
- **Version constraints**: Conservative dependency versioning
- **Graceful fallbacks**: expo-crypto optional, falls back to uuid package